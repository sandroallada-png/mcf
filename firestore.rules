rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FONCTIONS DE BASE ---
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'maxyculture11@gmail.com';
    }

    function isUser(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isFamilyMember(chefId) {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.chefId == chefId;
    }

    // --- UTILISATEURS & PROFILS ---
    match /users/{userId} {
      // Autoriser la consultation d'un profil par tout utilisateur authentifié (pour les invitations)
      allow get: if request.auth != null;
      // Listage autorisé pour les membres authentifiés pour les besoins du foyer
      allow list: if request.auth != null;
      allow create: if isUser(userId);
      allow update: if isUser(userId) || isAdmin();
      allow delete: if isAdmin();

      // Sous-collections (foodLogs, goals, cooking, pendingCookings, notifications, favoriteRecipes, analytics, etc.)
      match /{allPaths=**} {
        allow read, write: if isUser(userId) || isAdmin() || isFamilyMember(userId);
      }
    }

    // --- CONTENU PUBLIC (LECTURE) ---
    // On regroupe les contenus lisibles par tous
    
    match /dishes/{dishId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /dishes {
      allow list: if true;
    }

    match /promotions/{promotionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /promotions {
      allow list: if true;
    }
    
    match /carouselItems/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /carouselItems {
      allow list: if true;
    }
    
    match /publications/{publicationId} {
      allow read, list: if true;
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }

    match /atelierBooks/{bookId} {
      allow read, list: if true;
      allow write: if isAdmin();
    }

    // --- INTERACTIONS UTILISATEURS ---

    match /feedbacks/{feedbackId} {
      allow read, list: if true;
      allow create: if request.auth != null;
      allow update, delete: if isAdmin();
    }
    
    match /invites/{inviteId} {
      // Lecture obligatoire pour vérifier le chefId avant acceptation
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.chefId == request.auth.uid;
      allow update: if request.auth != null; 
      allow delete: if request.auth != null && (resource.data.chefId == request.auth.uid || isAdmin());
    }

    match /userContributions/{contributionId} {
      allow create: if request.auth != null && (request.resource.data.authorId == request.auth.uid || isAdmin());
      // L'auteur peut voir sa contribution, l'admin peut tout voir/gérer
      allow read, get, list: if isAdmin() || (request.auth != null && resource.data.authorId == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    match /missingMeals/{mealId} {
      allow create: if request.auth != null;
      allow read, list, write: if isAdmin();
    }

    // --- ADMINISTRATION ---

    match /notifications/{notificationId} { allow read, write: if isAdmin(); }
    match /messages/{messageId} { allow read, write: if isAdmin(); }
    
    // Explicit list for admin collections
    match /notifications { allow list: if isAdmin(); }
    match /messages { allow list: if isAdmin(); }
    match /missingMeals { allow list: if isAdmin(); }
  }
}
